{% extends 'base.html' %}
{% load static leaflet_tags %}
{% block extra_head %}
    {% leaflet_js %}
    {% leaflet_css %}
    <script src="{% static 'js/leaflet-heat.js' %}"></script>
{% endblock %}

{% block content %}
    <h1>Laser Vision Violation Reports</h1>
    <script>

      var paramsString = window.location.search;
      var searchParams = new URLSearchParams(paramsString);

      function writeQueryString() {
          if (history.pushState) {
              var newurl = (
                window.location.protocol + "//" +
                window.location.host +
                window.location.pathname +
                (searchParams.toString() ? '?' : '') + searchParams.toString()
              );
              window.history.pushState({path:newurl},'',newurl);
          }
      }

      function updateHeader(count) {
        if (searchParams.get('violation') === null) {
          document.getElementById("violationName").innerHTML = "<b>Violation</b>: All";
        } else {
          document.getElementById("violationName").innerHTML = `<b>Violation</b>: ${searchParams.get('violation')}`;
        }

        if (searchParams.get('date') !== null) {
          document.getElementById("violationDate").innerHTML = `<b>Date(s)</b>: ${searchParams.get('date')}`;
        } else if (searchParams.get('date_gte') !== null || searchParams.get('date_lte') !== null) {
          document.getElementById("violationDate").innerHTML = `<b>Date(s)</b>: ${searchParams.get('date_gte') ? searchParams.get('date_gte') : ''} - ${searchParams.get('date_lte') ? searchParams.get('date_lte') : ''}`;
        } else {
          document.getElementById("violationDate").innerHTML = `<b>Date(s)</b>: All`;
        }

        document.getElementById("violationCount").innerHTML = `<b>Count</b>: ${count}`;
      }

      function setDate(startOffset, endOffset = null) {
          if (startOffset === null && endOffset === null) {
              searchParams.delete('date');
              searchParams.delete('date_lte');
              searchParams.delete('date_gte');
          }
          let today = new Date();
          if (startOffset !== null && endOffset === null) {
              searchParams.delete('date_lte');
              searchParams.delete('date_gte');
              const querydate = new Date(today);
              querydate.setDate(today.getDate() + startOffset); 
              searchParams.set('date', querydate.toISOString().substring(0, 10));
          }
          if (startOffset !== null && endOffset !== null) {
              searchParams.delete('date');
              const startquerydate = new Date(today);
              startquerydate.setDate(today.getDate() + startOffset); 
              searchParams.set('date_gte', startquerydate.toISOString().substring(0, 10));
              const endquerydate = new Date(today);
              endquerydate.setDate(today.getDate() + endOffset); 
              searchParams.set('date_lte', endquerydate.toISOString().substring(0, 10));
          }
          writeQueryString();
          updateData();
      }

      function setViolation(violation) {
          if (violation === null) {
            searchParams.delete('violation');
          } else {
            searchParams.set('violation', violation);
          }
          writeQueryString();
          updateData();
      }

      function fetchData() {
        return fetch('/tools/laser/map_data/' + (searchParams.toString() ? '?' : '') + searchParams.toString())
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Response status: ${response.status}`);
            }
            const data = response.json();
            return data;
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });

        updateQueryString();
      }

      var heatmapLayer = L.heatLayer([]);

      function updateData() {
        fetchData()
          .then(data => {
            heatmapLayer.setOptions({radius: 10, blur: 5, minOpacity: .4});
            heatmapLayer.setLatLngs(data);
            heatmapLayer.redraw();
            updateHeader(data.length);
            setTimeout(updateData, 10000)
          });
      }
      function map_init (map, options) {
        map.setView([39.9528, -75.1635], 12);
        map.setMinZoom(12);
        const bounds = L.latLngBounds([[39.8819, -74.9495], [40.1440, -75.2727]]);
        map.setMaxBounds(bounds);
        map.on('drag', function() {
            map.panInsideBounds(bounds, { animate: false });
        });
        updateData();
        heatmapLayer.addTo(map);
      }
    </script>

    <div>
      <div id="violationName"><b>Violation</b>: {% if request.GET.violation %}{{ request.GET.violation }}{% else %}All{% endif %}</div>
      <div id="violationDate"><b>Date(s)</b>: {% if request.GET.date %}{{ request.GET.date }}{% elif request.GET.date_gte or request.GET.date_lte %}{% if request.GET.date_gte %}{{ request.GET.date_gte }}{% endif %} - {% if request.GET.date_lte %}{{ request.GET.date_lte }}{% endif %}{% else %}All{% endif %}</div>
      <div id="violationCount"><b>Count</b>: ...</div>
    </div>
    <div style="text-align: center">
      <button onclick="setDate(0)">Today</button>
      <button onclick="setDate(-1)">Yesterday</button>
      <button onclick="setDate(-6, 0)">Last 7 Days</button>
      <button onclick="setDate(-27, 0)">Last 28 Days</button>
      <button onclick="setDate(null)">All Time</button>
    </div>
    <div style="text-align: center; margin: .5em;">
      <button onclick="setViolation('Bike Lane')">Bike Lane</button>
      <button onclick="setViolation('Sidewalk')">Sidewalk</button>
      <button onclick="setViolation('Crosswalk')">Crosswalk</button>
      <button onclick="setViolation('Corner Clearance')">Corner Clearance</button>
      <button onclick="setViolation('Handicap Ramp')">Handicap Ramp</button>
      <button onclick="setViolation(null)">All</button>
    </div>
    {% leaflet_map "lazer_reports" callback="window.map_init" %}
{% endblock %}
